<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è‚¡ç¥¨æˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        /* --- å…¨åŸŸèˆ‡ç‰ˆé¢ --- */
        body {
            background-color: #f4f7f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 20px; margin: 0; min-height: 100vh;
        }
        .nav-container {
            background-color: #e0e0e0; padding: 5px; border-radius: 50px;
            display: flex; gap: 5px; margin-bottom: 20px;
        }
        .nav-btn {
            padding: 10px 30px; border: none; border-radius: 40px;
            font-size: 16px; cursor: pointer; font-weight: 600; color: #666; background: transparent; transition: all 0.3s;
        }
        .nav-btn.active { background-color: #ffffff; color: #d32f2f; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .page-section {
            display: none; background-color: #ffffff; padding: 30px;
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 950px; 
        }
        .page-section.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #page-input { width: 600px; } 
        #page-analysis { width: 900px; } 

        /* --- æ—¥æ›†ç›¸é—œæ¨£å¼ --- */
        .calendar-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 25px; background-color: #f9f9f9; padding: 15px; border-radius: 15px; }
        .date-navigator { display: flex; align-items: center; gap: 10px; }
        select.nav-select { font-size: 18px; font-weight: bold; padding: 5px 10px; border: 1px solid #ddd; border-radius: 8px; background-color: white; outline: none; }
        .circle-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .circle-btn:hover { background-color: #e0e0e0; }
        .btn-today { font-size: 14px; padding: 5px 12px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; }
        .mode-switch { display: flex; background: #eee; border-radius: 8px; overflow: hidden; }
        .mode-btn { padding: 8px 15px; border: none; cursor: pointer; background: transparent; }
        .mode-btn.current { background-color: #333; color: #fff; font-weight: bold; }
        #api-status { font-size: 13px; color: #888; min-width: 80px; text-align: right; }

        #calendar_area { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .week_header { text-align: center; font-weight: bold; color: #888; padding-bottom: 5px; }
        .weekend { color: #e74c3c; }
        .day_box { height: 140px; background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .day_box:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 5; }
        .day_number { font-weight: bold; color: #444; font-size: 18px; }
        
        .day_box.bg-profit { background-color: #ffebee; border: 2px solid #ef5350; }
        .day_box.bg-loss { background-color: #e8f5e9; border: 2px solid #66bb6a; }
        .day_box.bg-zero { background-color: #f5f5f5; }
        
        /* å­—é«”è¨­å®š */
        .profit-text { 
            font-size: 18px; font-weight: 900; text-align: right; padding-right: 5px; 
            letter-spacing: -0.5px; font-family: 'Arial Black', 'Segoe UI Black', sans-serif;
        }
        .profit-percent { 
            font-size: 12px; text-align: right; padding-right: 5px; 
            font-weight: 700; opacity: 0.9; margin-top: -3px;
        }
        .day_box.bg-profit .profit-text, .day_box.bg-profit .profit-percent { color: #c62828; }
        .day_box.bg-loss .profit-text, .day_box.bg-loss .profit-percent { color: #2e7d32; }

        /* --- è¼¸å…¥é æ¨£å¼ --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-weight: 500; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-save { flex: 2; padding: 12px; background-color: #d32f2f; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn-clear { flex: 1; padding: 12px; background-color: #757575; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        #inventory-list { width: 100%; margin-top: 30px; border-collapse: collapse; }
        #inventory-list th, #inventory-list td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
        #inventory-list th { background-color: #f9f9f9; color: #555; }
        .delete-btn { color: red; cursor: pointer; font-weight: bold; }
        .summary-box { background-color: #fff3e0; color: #e65100; padding: 15px; border-radius: 10px; margin-top: 20px; font-weight: bold; text-align: center; }

        /* --- è³‡ç”¢åˆ†æé æ¨£å¼ --- */
        .chart-row { display: flex; gap: 30px; margin-bottom: 30px; align-items: flex-start; }
        .chart-container-pie { flex: 1; background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 20px; height: 350px; display: flex; justify-content: center; align-items: center; }
        .chart-container-line { width: 100%; height: 350px; background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 20px; margin-bottom: 30px; position: relative;}
        .stats-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .stat-card { background: #f8f9fa; border-left: 5px solid #333; padding: 15px; border-radius: 8px; }
        .stat-card h4 { margin: 0 0 5px 0; color: #666; font-size: 14px; }
        .stat-card .val { font-size: 24px; font-weight: bold; color: #333; }
        #agg-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        #agg-table th { background: #eee; text-align: left; padding: 8px; }
        #agg-table td { border-bottom: 1px solid #f0f0f0; padding: 8px; }

        #chart-loading { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(255,255,255,0.8); display: none; 
            justify-content: center; align-items: center; font-weight: bold; color: #666;
            border-radius: 15px; z-index: 10;
        }
    </style>
</head>

<body>
    <div class="nav-container">
        <button id="tab-1" class="nav-btn active" onclick="switchPage(1)">ğŸ“… æç›Šè¡Œäº‹æ›†</button>
        <button id="tab-2" class="nav-btn" onclick="switchPage(2)">ğŸ“ åº«å­˜ç®¡ç†</button>
    </div>

    <div id="page-calendar" class="page-section show">
        <div class="calendar-controls">
            <div class="date-navigator">
                <button id="btn-prev" class="circle-btn" onclick="changeMonth(-1)">â€¹</button>
                <select id="select_year" class="nav-select" onchange="DrawCalendar()"></select>
                <select id="select_month" class="nav-select" onchange="DrawCalendar()"></select>
                <button id="btn-next" class="circle-btn" onclick="changeMonth(1)">â€º</button>
                <button class="btn-today" onclick="goToToday()">å›åˆ°æœ¬æœˆ</button>
            </div>
            <div class="mode-switch">
                <button id="mode-daily" class="mode-btn current" onclick="changeMode('daily')">å–®æ—¥æ¼²è·Œ</button>
                <button id="mode-total" class="mode-btn" onclick="changeMode('total')">ç´¯ç©æç›Š</button>
            </div>
            <span id="api-status"></span>
        </div>
        <div id="calendar_area"></div>
    </div>

    <div id="page-input" class="page-section">
        <h2 style="text-align:center">æ–°å¢äº¤æ˜“ç´€éŒ„</h2>
        <div class="form-group"><label>è‚¡ç¥¨ä»£ç¢¼</label><input type="text" id="inp_code"></div>
        <div class="form-group"><label>äº¤æ˜“æ—¥æœŸ</label><input type="date" id="inp_date"></div>
        <div class="form-group"><label>æˆäº¤åƒ¹æ ¼</label><input type="number" id="inp_price"></div>
        <div class="form-group"><label>æˆäº¤è‚¡æ•¸</label><input type="number" id="inp_amount"></div>
        <div class="form-group"><label>æ‰‹çºŒè²»</label><input type="number" id="inp_fee"></div>
        <div class="btn-group">
            <button class="btn-clear" onclick="clearInputs()">æ¸…é™¤é‡å¡«</button>
            <button class="btn-save" onclick="addStock()">ï¼‹ æ–°å¢ç´€éŒ„</button>
        </div>
        <div id="summary_area" class="summary-box">ç›®å‰ç„¡æŒè‚¡è³‡æ–™</div>
        <table id="inventory-list">
            <thead><tr><th>æ—¥æœŸ</th><th>ä»£è™Ÿ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="inventory-body"></tbody>
        </table>
    </div>

    <div id="page-analysis" class="page-section">
        <h2 style="text-align:center; margin-bottom:30px;">è³‡ç”¢ç¸½è¦½èˆ‡åˆ†å¸ƒ</h2>
        
        <div class="chart-row">
            <div class="chart-container-pie">
                <canvas id="pieChart"></canvas>
            </div>
            <div class="stats-panel">
                <div class="stat-card" style="border-left-color: #d32f2f;">
                    <h4>ç¸½æŠ•å…¥æˆæœ¬ (Estimated Cost)</h4>
                    <div class="val" id="total-invested-val">$0</div>
                </div>
                <div style="background:#fff; border:1px solid #eee; border-radius:10px; overflow:hidden; padding:10px;">
                    <h4 style="margin:5px 0 10px 5px;">æŒè‚¡åˆä½µæ¸…å–®</h4>
                    <table id="agg-table">
                        <thead><tr><th>ä»£è™Ÿ</th><th>ç¸½è‚¡æ•¸</th><th>å¹³å‡æˆæœ¬</th></tr></thead>
                        <tbody id="agg-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <h3 style="margin-left:10px;">è³‡ç”¢å¸‚å€¼è¶¨å‹¢</h3>
        <div class="chart-container-line">
            <div id="chart-loading">æ­£åœ¨è¨ˆç®—æ­·å²å¸‚å€¼...</div>
            <canvas id="lineChart"></canvas>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        let myStockData = JSON.parse(localStorage.getItem("myStockData")) || [];
        let marketPriceCache = {}; 
        let viewMode = 'daily'; 
        const MIN_YEAR = 2025;
        const MAX_YEAR = 2035;
        
        let myPieChart = null;
        let myLineChart = null;

        init();

        function init() {
            generateSelects(); 
            goToToday(false);  
            document.getElementById('inp_date').valueAsDate = new Date();
            updateInventoryTable();
            DrawCalendar();    
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${pageId}`).classList.add('active');

            if(pageId === 1) {
                document.getElementById('page-calendar').classList.add('show');
                DrawCalendar(); 
            } else if (pageId === 2) {
                document.getElementById('page-input').classList.add('show');
            } else if (pageId === 3) {
                document.getElementById('page-analysis').classList.add('show');
                renderAnalysis(); 
            }
        }

        async function renderAnalysis() {
            if(myStockData.length === 0) return;

            // 1. åŸºæœ¬çµ±è¨ˆ
            let portfolio = {};
            let totalInvested = 0;
            myStockData.forEach(item => {
                if(!portfolio[item.code]) { portfolio[item.code] = { amount: 0, cost: 0 }; }
                portfolio[item.code].amount += item.amount;
                portfolio[item.code].cost += item.total;
                totalInvested += item.total;
            });

            document.getElementById("total-invested-val").innerText = "$" + Math.floor(totalInvested).toLocaleString();
            updateAggTableAndPie(portfolio);

            // 2. æº–å‚™ç•«æŠ˜ç·šåœ–
            document.getElementById("chart-loading").style.display = "flex";
            
            let sortedData = [...myStockData].sort((a,b) => new Date(a.date) - new Date(b.date));
            let minDate = sortedData[0].date;
            let activeCodes = Object.keys(portfolio);

            let historyPrices = await fetchAllHistoryData(activeCodes, minDate);

            // å–å¾—æ¯é€±æ•¸æ“š
            let trendData = calculateWeeklyTrend(sortedData, historyPrices);
            
            drawLineChart(trendData.dates, trendData.marketValues, trendData.costValues);
            document.getElementById("chart-loading").style.display = "none";
        }

        async function fetchAllHistoryData(codes, startDateStr) {
            let priceMap = {}; 
            let today = new Date();
            let y = today.getFullYear();
            let m = String(today.getMonth() + 1).padStart(2, '0');
            let d = String(today.getDate()).padStart(2, '0');
            let endDateStr = `${y}-${m}-${d}`;

            let promises = codes.map(async (code) => {
                let url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${code}&start_date=${startDateStr}&end_date=${endDateStr}`;
                try {
                    let res = await fetch(url);
                    let result = await res.json();
                    if(result.data) {
                        result.data.forEach(item => {
                            if(!priceMap[item.date]) priceMap[item.date] = {};
                            priceMap[item.date][code] = item.close;
                        });
                    }
                } catch (e) { console.error(e); }
            });
            await Promise.all(promises);
            return priceMap;
        }

        function calculateWeeklyTrend(transactions, historyPrices) {
            let dates = [];
            let marketValues = [];
            let costValues = [];

            let allDates = Object.keys(historyPrices).sort();
            if(allDates.length === 0) return { dates:[], marketValues:[], costValues:[] };

            let today = new Date();
            let y = today.getFullYear();
            let m = String(today.getMonth() + 1).padStart(2, '0');
            let d = String(today.getDate()).padStart(2, '0');
            let todayStr = `${y}-${m}-${d}`;

            allDates.forEach(dateStr => {
                let dateObj = new Date(dateStr);
                let dayOfWeek = dateObj.getDay(); 

                // åªæŠ“ é€±äº” æˆ– ä»Šå¤©
                let isFriday = (dayOfWeek === 5);
                let isToday = (dateStr === todayStr);

                if (isFriday || isToday) {
                    let currentMarketValue = 0;
                    let currentTotalCost = 0;

                    let validTrans = transactions.filter(t => t.date <= dateStr);

                    let holdings = {};
                    validTrans.forEach(t => {
                        if(!holdings[t.code]) holdings[t.code] = 0;
                        holdings[t.code] += t.amount;
                        currentTotalCost += t.total;
                    });

                    for(let code in holdings) {
                        let amount = holdings[code];
                        let price = historyPrices[dateStr][code]; 
                        if(price) {
                            currentMarketValue += (amount * price);
                        }
                    }

                    dates.push(dateStr);
                    marketValues.push(currentMarketValue);
                    costValues.push(currentTotalCost);
                }
            });

            return { dates, marketValues, costValues };
        }

        function updateAggTableAndPie(portfolio) {
            let aggBody = document.getElementById("agg-body");
            aggBody.innerHTML = "";
            let labels = []; 
            let dataCost = []; 

            for (let code in portfolio) {
                let p = portfolio[code];
                let avgPrice = (p.cost / p.amount).toFixed(2);
                aggBody.innerHTML += `<tr><td style="font-weight:bold; color:#d32f2f;">${code}</td><td>${p.amount.toLocaleString()} è‚¡</td><td>$${avgPrice}</td></tr>`;
                labels.push(code);
                dataCost.push(p.cost);
            }
            drawPieChart(labels, dataCost);
        }

        function drawPieChart(labels, data) {
            let ctx = document.getElementById('pieChart').getContext('2d');
            if(myPieChart) myPieChart.destroy(); 

            myPieChart = new Chart(ctx, {
                type: 'doughnut', 
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', onClick: (e) => { return; } },
                        datalabels: {
                            color: '#fff', font: { weight: 'bold', size: 14 },
                            formatter: (value, ctx) => {
                                let sum = 0;
                                ctx.chart.data.datasets[0].data.map(data => sum += data);
                                return (value*100 / sum).toFixed(1)+"%";
                            }
                        }
                    }
                }
            });
        }

        // ğŸ”¥ ä¿®æ”¹ï¼šå…©æ¢å¯¦ç·š
        function drawLineChart(dates, marketValues, costValues) {
            let ctx = document.getElementById('lineChart').getContext('2d');
            if(myLineChart) myLineChart.destroy();

            myLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'ç¾åœ¨åƒ¹å€¼',
                            data: marketValues,
                            borderColor: '#2e7d32', // ç¶ è‰²
                            backgroundColor: 'rgba(46, 125, 50, 0.1)',
                            fill: true,
                            tension: 0.2
                        },
                        {
                            label: 'ç´¯ç©æˆæœ¬',
                            data: costValues,
                            borderColor: '#d32f2f', // ç´…è‰²
                            // borderDash ç§»é™¤äº†ï¼Œè®Šæˆå¯¦ç·š
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { onClick: (e) => { return; } }, 
                        datalabels: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += '$' + Math.round(context.parsed.y).toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // --- åŸæœ‰åŠŸèƒ½ ---
        function clearInputs() { document.getElementById("inp_code").value = ""; document.getElementById("inp_price").value = ""; document.getElementById("inp_amount").value = ""; document.getElementById("inp_fee").value = ""; document.getElementById("inp_date").valueAsDate = new Date(); }
        function generateSelects() { let yearSelect = document.getElementById("select_year"); let monthSelect = document.getElementById("select_month"); let yHtml = ""; for (let y = MIN_YEAR; y <= MAX_YEAR; y++) yHtml += `<option value="${y}">${y} å¹´</option>`; yearSelect.innerHTML = yHtml; let mHtml = ""; for (let m = 1; m <= 12; m++) mHtml += `<option value="${m}">${m} æœˆ</option>`; monthSelect.innerHTML = mHtml; }
        function goToToday(redraw = true) { let now = new Date(); let y = now.getFullYear(); let m = now.getMonth() + 1; if (y < MIN_YEAR) y = MIN_YEAR; if (y > MAX_YEAR) y = MAX_YEAR; document.getElementById("select_year").value = y; document.getElementById("select_month").value = m; if (redraw) DrawCalendar(); }
        function changeMonth(delta) { let yearSelect = document.getElementById("select_year"); let monthSelect = document.getElementById("select_month"); let currentY = parseInt(yearSelect.value); let currentM = parseInt(monthSelect.value); let newM = currentM + delta; let newY = currentY; if (newM > 12) { newM = 1; newY++; } else if (newM < 1) { newM = 12; newY--; } if (newY < MIN_YEAR || newY > MAX_YEAR) return; yearSelect.value = newY; monthSelect.value = newM; DrawCalendar(); }
        function changeMode(mode) { viewMode = mode; document.getElementById('mode-daily').className = (mode === 'daily') ? 'mode-btn current' : 'mode-btn'; document.getElementById('mode-total').className = (mode === 'total') ? 'mode-btn current' : 'mode-btn'; let year = parseInt(document.getElementById("select_year").value); let month = parseInt(document.getElementById("select_month").value); let daysInMonth = new Date(year, month, 0).getDate(); calculateAndRenderProfit(year, month, daysInMonth); }
        async function DrawCalendar() { let area = document.getElementById("calendar_area"); let statusLabel = document.getElementById("api-status"); let year = parseInt(document.getElementById("select_year").value); let month = parseInt(document.getElementById("select_month").value); updateButtonState(year, month); let daysInMonth = new Date(year, month, 0).getDate(); let firstDay = new Date(year, month - 1, 1).getDay(); let htmlContent = ""; let weeks = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"]; weeks.forEach((w, index) => { let className = index === 0 || index === 6 ? "week_header weekend" : "week_header"; htmlContent += `<div class="${className}">${w}</div>`; }); for (let i = 0; i < firstDay; i++) htmlContent += `<div class="empty_box"></div>`; for (let i = 1; i <= daysInMonth; i++) { htmlContent += `<div id="day-box-${i}" class="day_box"><div class="day_number">${i}</div><div id="cell-data-${i}" class="loading-text"></div></div>`; } area.innerHTML = htmlContent; statusLabel.innerText = "â³ è®€å–ä¸­..."; let activeCodes = getActiveStockCodes(); if (activeCodes.length === 0) { statusLabel.innerText = "ç„¡åº«å­˜"; clearLoadingText(daysInMonth); return; } await fetchMarketDataForMonth(year, month, activeCodes); statusLabel.innerText = "âœ… å®Œæˆ"; calculateAndRenderProfit(year, month, daysInMonth); }
        function updateButtonState(year, month) { let prevBtn = document.getElementById("btn-prev"); let nextBtn = document.getElementById("btn-next"); if (year === MIN_YEAR && month === 1) prevBtn.disabled = true; else prevBtn.disabled = false; if (year === MAX_YEAR && month === 12) nextBtn.disabled = true; else nextBtn.disabled = false; }
        async function fetchMarketDataForMonth(year, month, codes) { marketPriceCache = {}; let startDateObj = new Date(year, month - 1, 1); startDateObj.setDate(startDateObj.getDate() - 7); let y = startDateObj.getFullYear(); let m = String(startDateObj.getMonth() + 1).padStart(2, '0'); let d = String(startDateObj.getDate()).padStart(2, '0'); let startDateStr = `${y}-${m}-${d}`; let promises = codes.map(async (code) => { let url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${code}&start_date=${startDateStr}`; try { let res = await fetch(url); let result = await res.json(); if(result.data) { result.data.forEach(item => { let key = `${code}-${item.date}`; marketPriceCache[key] = item.close; }); } } catch (e) { console.error(e); } }); await Promise.all(promises); }
        function calculateAndRenderProfit(year, month, totalDays) { for (let i = 1; i <= totalDays; i++) { let cellText = document.getElementById(`cell-data-${i}`); let dayBox = document.getElementById(`day-box-${i}`); cellText.innerHTML = ""; dayBox.className = "day_box"; let todayStr = `${year}-${String(month).padStart(2, '0')}-${String(i).padStart(2, '0')}`; let todayDateObj = new Date(year, month - 1, i); let yesterdayDateObj = new Date(todayDateObj); yesterdayDateObj.setDate(todayDateObj.getDate() - 1); let myHoldings = myStockData.filter(stock => stock.date <= todayStr); if (myHoldings.length === 0) continue; let totalProfit = 0; let percentDenominator = 0; let hasData = false; myHoldings.forEach(stock => { let stockCode = stock.code; let todayPrice = marketPriceCache[`${stockCode}-${todayStr}`]; if (todayPrice !== undefined) { hasData = true; let diff = 0; let cost = (stock.price * stock.amount) + (stock.fee || 0); if (viewMode === 'total') { let marketValue = todayPrice * stock.amount; diff = marketValue - cost; percentDenominator += cost; } else { if (stock.date === todayStr) { let marketValue = todayPrice * stock.amount; diff = marketValue - cost; percentDenominator += cost; } else { let prevPrice = findPreviousClosePrice(stockCode, yesterdayDateObj); if (prevPrice !== null) { diff = (todayPrice - prevPrice) * stock.amount; percentDenominator += (prevPrice * stock.amount); } else { diff = 0; } } } totalProfit += diff; } }); if (hasData) { let sign = totalProfit > 0 ? "+" : ""; if (totalProfit > 0) { dayBox.classList.add("bg-profit"); } else if (totalProfit < 0) { dayBox.classList.add("bg-loss"); } else { dayBox.classList.add("bg-zero"); } let html = `<div class="profit-text">${sign}${Math.round(totalProfit).toLocaleString()}</div>`; if (percentDenominator > 0) { let percent = (totalProfit / percentDenominator) * 100; let pSign = percent > 0 ? "+" : ""; html += `<div class="profit-percent">${pSign}${percent.toFixed(2)}%</div>`; } cellText.innerHTML = html; } } }
        function findPreviousClosePrice(code, startDateObj) { let tempDate = new Date(startDateObj); for (let k = 0; k < 5; k++) { let y = tempDate.getFullYear(); let m = String(tempDate.getMonth() + 1).padStart(2, '0'); let d = String(tempDate.getDate()).padStart(2, '0'); let dateStr = `${y}-${m}-${d}`; let price = marketPriceCache[`${code}-${dateStr}`]; if (price !== undefined) return price; tempDate.setDate(tempDate.getDate() - 1); } return null; }
        function getActiveStockCodes() { let codes = myStockData.map(d => d.code); return [...new Set(codes)]; }
        function clearLoadingText(days) { for(let i=1; i<=days; i++) document.getElementById(`cell-data-${i}`).innerHTML = ""; }
        function addStock() { let code = document.getElementById("inp_code").value; let date = document.getElementById("inp_date").value; let priceStr = document.getElementById("inp_price").value; let amountStr = document.getElementById("inp_amount").value; let feeStr = document.getElementById("inp_fee").value; if (!code || !priceStr || !amountStr || !date) { alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼"); return; } let price = parseFloat(priceStr); let amount = parseInt(amountStr); let fee = parseInt(feeStr) || 0; let totalCost = (price * amount) + fee; let newRecord = { id: Date.now(), code, date, price, amount, fee, total: totalCost }; myStockData.push(newRecord); localStorage.setItem("myStockData", JSON.stringify(myStockData)); updateInventoryTable(); alert("å„²å­˜æˆåŠŸï¼"); clearInputs(); }
        function updateInventoryTable() { let tbody = document.getElementById("inventory-body"); let summaryDiv = document.getElementById("summary_area"); tbody.innerHTML = ""; let totalMoney = 0; myStockData.sort((a, b) => new Date(b.date) - new Date(a.date)); myStockData.forEach(item => { totalMoney += item.total; tbody.innerHTML += `<tr><td>${item.date}</td><td><b>${item.code}</b></td><td>${item.price}</td><td>${item.amount}</td><td><span class="delete-btn" onclick="deleteStock(${item.id})">åˆªé™¤</span></td></tr>`; }); if (myStockData.length > 0) { summaryDiv.innerHTML = `ğŸ’° ç¸½æŠ•å…¥æˆæœ¬ï¼š$${Math.floor(totalMoney).toLocaleString()}`; } else { summaryDiv.innerHTML = "ç›®å‰ç„¡æŒè‚¡è³‡æ–™"; } }
        function deleteStock(id) { if(!confirm("ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return; myStockData = myStockData.filter(item => item.id !== id); localStorage.setItem("myStockData", JSON.stringify(myStockData)); updateInventoryTable(); }
    </script>
</body>
</html>